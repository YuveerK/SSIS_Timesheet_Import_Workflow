name: Deploy SSIS Project

on:
  push:
    branches: [main]

jobs:
  deploy-ssis:
    name: Deploy SSIS Project (.ispac)
    runs-on: [self-hosted, windows]

    env:
      ISPAC_PATH: "C:\\dev_zone\\SSIS_Timesheet_Import_Workflow\\Normalized_SSIS_Project.ispac"
      SQL_SERVER: "YUVEER"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare temp deploy script
        shell: powershell
        run: |
          $sql = @"
          :setvar IspacFullPath `"$env:ISPAC_PATH`"
          :r scripts/create-db-and-tables.sql
          "@
          $sql | Out-File -FilePath temp-deploy.sql -Encoding ASCII

      - name: Deploy .ispac to SSISDB using Windows Auth
        shell: cmd
        run: |
          sqlcmd -S %SQL_SERVER% -E -i temp-deploy.sql

  deploy-sql:
    name: Create & Run SQL Agent Job (Remote SQL)
    runs-on: windows-latest
    needs: deploy-ssis

    env:
      SQL_SERVER: "102.182.237.40,1433"
      SQL_USER: "Auto_User_2"
      SQL_PASSWORD: "Test@1234"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create or update SQL Agent job (SSIS Package)
        shell: cmd
        run: |
          sqlcmd -S %SQL_SERVER% -U %SQL_USER% -P %SQL_PASSWORD% -i scripts/create-import-job.sql

      - name: Run SQL Agent Job (import data)
        shell: cmd
        run: |
          sqlcmd -S %SQL_SERVER% -U %SQL_USER% -P %SQL_PASSWORD% -Q "EXEC msdb.dbo.sp_start_job @job_name = N'import data'"
