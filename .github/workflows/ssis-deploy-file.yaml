name: Deploy SSIS Project

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: [self-hosted, windows]

    env:
      ISPAC_PATH: "C:\\dev_zone\\SSIS_Timesheet_Import_Workflow\\Normalized_SSIS_Project.ispac"

    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ Prepare temp deploy script
        shell: powershell
        run: |
          Write-Host "ğŸ”„ Starting to build temp-deploy.sqlâ€¦" 
          $sql = @"
          :setvar IspacFullPath "$env:ISPAC_PATH"
          :r scripts/create-db-and-tables.sql
          "@
          $sql | Out-File -FilePath temp-deploy.sql -Encoding ASCII
          Write-Host "âœ… temp-deploy.sql created successfully! ğŸ‰"

      - name: ğŸš€ Deploy .ispac to SSISDB using Windows Auth
        shell: cmd
        run: |
          echo ğŸ”„ "Running temp-deploy.sql against SSISDBâ€¦" 
          sqlcmd -S YUVEER -E -i temp-deploy.sql -b -o deploy.log
          if %ERRORLEVEL% NEQ 0 (
            echo âŒ "SSISDB deployment failed! Check deploy.log"
            exit /b %ERRORLEVEL%
          ) else (
            echo âœ… "SSIS project deployed to SSISDB successfully! ğŸ“¦"
          )

      - name: ğŸ› ï¸ Create or update SQL Agent job (SSIS Package)
        shell: cmd
        run: |
          echo ğŸ”„ "Running create-import-job.sqlâ€¦" 
          sqlcmd -S YUVEER -E -i scripts/create-import-job.sql -b -o job-setup.log
          if %ERRORLEVEL% NEQ 0 (
            echo âŒ "Agent job creation/update failed! See job-setup.log"
            exit /b %ERRORLEVEL%
          ) else (
            echo âœ… "SQL Agent job is ready! ğŸƒ"
          )

      - name: â–¶ï¸ Run SQL Agent Job (import data)
        shell: cmd
        run: |
          echo ğŸ”„ "Starting the 'import data' jobâ€¦" 
          sqlcmd -S YUVEER -E -Q "EXEC msdb.dbo.sp_start_job @job_name = N'import data'" -b -o run-job.log
          if %ERRORLEVEL% NEQ 0 (
            echo âŒ "Failed to start import job! Check run-job.log"
            exit /b %ERRORLEVEL%
          ) else (
            echo âœ… "Import job started! Check SSISDB for logs. ğŸ“Š"
          )
