name: 🚀 Deploy SSIS Project

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: [self-hosted, windows]

    env:
      ISPAC_PATH: "C:\\dev_zone\\SSIS_Timesheet_Import_Workflow\\Normalized_SSIS_Project.ispac"

    steps:
      - name: 📦 Checkout source code from GitHub
        uses: actions/checkout@v4

      - name: 📝 Prepare dynamic SQL deployment script
        shell: powershell
        run: |
          Write-Host "🛠️ Preparing SQL deployment script..."
          $sql = @"
          :setvar IspacFullPath "$env:ISPAC_PATH"
          :r scripts/create-db-and-tables.sql
          "@
          $sql | Out-File -FilePath temp-deploy.sql -Encoding ASCII
          Write-Host "✅ temp-deploy.sql created."

      - name: 📤 Deploy .ispac to SSISDB (Windows Authentication)
        shell: cmd
        run: |
          echo 🔄 Running .ispac deployment via sqlcmd...
          sqlcmd -S YUVEER -E -i temp-deploy.sql
          echo ✅ SSIS project deployed to SSISDB.

      - name: 🛠️ Create or update SQL Agent Job
        shell: cmd
        run: |
          echo 🔄 Creating/updating SQL Server Agent Job...
          sqlcmd -S YUVEER -E -i scripts/create-import-job.sql
          echo ✅ Job created or updated successfully.

      - name: ▶️ Run SQL Agent Job (import data)
        shell: cmd
        run: |
          echo 🚀 Starting SQL Agent Job: import data...
          sqlcmd -S YUVEER -E -Q "EXEC msdb.dbo.sp_start_job @job_name = N'import data'"
          echo ✅ Job execution triggered.
